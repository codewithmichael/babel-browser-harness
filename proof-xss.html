<!--
BBH ♥ Babel Browser Harness
In-browser CDN-based ES6+ transpiling via Babel
Copyright (c) 2016, Michael Spencer
MIT License

PROOF OF CONCEPT:
Scripts can be stored externally and loaded via IFrame without a web server.

Additional: Without same-origin protection, the equivalent of CORS (cross-origin
            resource sharing) is possible, which could lead to XSS problems.

To run this proof, enable a webserver for the working directory on
http://localhost:8000 and then open this file directly (not using the local web
server)
-->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Babel Browser Harness</title>
    <script src="./bbh.js"></script>
  </head>
  <body>
    <div id="app">

      <!------------------------>
      <!-- ♦ YOUR CODE HERE ♦ -->
      <!------------------------>

      <!-- Example -->
      <script type="text/babel">
        import { message as goodMessage } from 'proof'
        import { message as badMessage } from 'proof-xss'

        clear()
        addDiv(`BBH ♥ ${ goodMessage }`)
        addDiv(`BBH ♥ ${ badMessage }`)

        function clear() {
          document.getElementById('app').textContent = ''
        }
        function addDiv(content) {
          let div = document.createElement('div')
          div.textContent = content
          document.getElementById('app').appendChild(div)
        }
      </script>

    </div>

    <script>
      !function() {

        // Intended use
        loadContentViaIframe(goodRemoteFunction, { name: "proof", id: "proof-intended", src: 'http://localhost:8000/proof-xss1.html' });

        // Unintended (XSS) use
        loadContentViaIframe(badRemoteFunction, { name: "proof-xss", id: "proof-xss", src: 'http://localhost:8000/proof-xss1.html' });

        // Unintended (XSS) use with CORS protection
        // NO RESPONSE SHOULD OCCUR
        loadContentViaIframe(badRemoteFunction, { name: "proof-protected", id: "proof-xss-cors-protection", src: 'http://localhost:8000/proof-xss2.html' });

        function goodRemoteFunction(_) {
          var a = document.querySelector('script[type="text/babel"]');
          if (a) {
            _.source.postMessage({
              id: _.data.id,
              content: a.textContent,
            }, '*')
          }
        }

        function badRemoteFunction(_) {
          fetch('./proof-xss-content.html')
            .then(function(res) {
              return res.text();
            })
            .then(function(text) {
              return 'export const message = "' + text.trim().replace(/"/g, "\\\"") + '"';
            })
            .then(function(content) {
              _.source.postMessage({
                id: _.data.id,
                content: content,
              }, '*')
            })
        }

        function loadContentViaIframe(remoteFunction, options) {
          var iframe = document.createElement('iframe');

          iframe.src = options.src;
          iframe.style = "display:none";
          registerMessageListener(iframe, options.id, options.name);
          registerIframeOnload(iframe, remoteFunction, options.id);
          document.body.appendChild(iframe);


          // Register local window listener
          function registerMessageListener(iframe, id, name) {
            window.addEventListener('message', $)

            function $(_) {
              if (_.data.id === id) {
                console.log('proof: received' + (_.data.id ? ' (' + _.data.id + ')' : ''), '\n', _)
                var script = document.createElement('script');
                script.type="text/babel";
                script.setAttribute('name', name);
                script.textContent = _.data.content;
                document.body.appendChild(script);
                window.removeEventListener('message', $)
                iframe.remove()
              }
            }
          }

          // Register onload for IFrame
          function registerIframeOnload(iframe, remoteFunction, id) {
            iframe.onload = onload;

            function onload() {
              var data = {
                id: id,
                eval: '('+remoteFunction.toString()+')(arguments[0])'
              }
              iframe.contentWindow.postMessage(data, '*')
            }
          }
        }
      }()
    </script>
  </body>
</html>
